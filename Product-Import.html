<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<title>Bulk Order</title>
		<!-- <link rel="stylesheet" type="text/css" href="css/bootstrap.css"> -->
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
		<link rel="stylesheet" href="https://daneden.github.io/animate.css/animate.min.css"> <!--  -->
		<link type="text/css" rel="stylesheet" href="https://docs.handsontable.com/pro/1.7.0/bower_components/handsontable-pro/dist/handsontable.full.min.css">
		<link rel="stylesheet" href="css/custom-style.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<style type="text/css">
			.affix{
				top:0px;
				width:100%;
				z-index: 999999;
			}

			.ht_clone_top, .ht_clone_top_left_corner{
				top:68px !important;
				display: none;
				/*position: fixed !important;*/
			}
		</style>
	</head>
	<body>

		<div id="tagModal" class="modal modal-wide fade" tabindex="-1" role="dialog" aria-labelledby="tagModal" aria-hidden="true" style="">
		  <div class="modal-dialog">

		    <!-- Modal content-->
		    <div class="modal-content w3-white w3-card-2" style="border-radius:2px;">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal">&times;</button>
		        <h4 class="modal-title">Select Tags</h4>
		      </div>
		      <div class="modal-body">
		        <p>Some text in the modal.</p>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		      </div>
		    </div>

		  </div>
		</div>

		<div id="optionModal" class="modal modal-wide fade" tabindex="-1" role="dialog" aria-labelledby="optionModal" aria-hidden="true" style="">
		  <div class="modal-dialog">

		    <!-- Modal content-->
		    <div class="modal-content w3-white w3-card-2" style="border-radius:2px;">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal">&times;</button>
		        <h4 class="modal-title">Select Options</h4>
		      </div>
		      <div class="modal-body">
		        <p>Some text in the modal.</p>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		      </div>
		    </div>

		  </div>
		</div>

		<div id="imageModal" class="modal modal-wide animated fade1 flyIn" tabindex="-1" role="dialog" aria-labelledby="imageModal" aria-hidden="true" style="">
		  <div class="modal-dialog">

		    <!-- Modal content-->
		    <div class="modal-content w3-white w3-card-2" style="border-radius:2px;">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal">&times;</button>
		        <h4 class="modal-title">Add Images</h4>
		      </div>
		      <div class="modal-body">
		      	<div class="container-fluid">
		      		<div class="row">
		      			<div class="col-sm-5">
		      				<label>Upload from Local System</label>
				      		<input id="imgFileBrowse" type="file" class="" onchange="encodeImageFileAsURL(this)" style="width:0px; height:0px; overflow:hidden;" accept="image/*" />
		      				<div class="input-group">
			      				<input id="imgFileTxt" type="text" readonly class="form-control" style="cursor:default;" onclick="document.getElementById('imgFileBrowse').click();" />
			      				<span class="input-group-btn">
				      				<button class="btn btn-default" onclick="document.getElementById('imgFileBrowse').click();" >Browse</button>
			      				</span>
			      			</div>
		      			</div>
		      			<div class="col-sm-2 text-center">
		      				<span>-OR-</span>
		      			</div>
		      			<div class="col-sm-5">
		      				<label>Upload via URL</label>
		      				<div class="input-group">
			      				<input id="imgFileUrl" type="url" class="form-control" />
			      				<span class="input-group-btn">
				      				<button class="btn btn-default" onclick="urlFileLoad2(document.getElementById('imgFileUrl').value);" >Add</button>
			      				</span>
			      			</div>
		      			</div>
		      		</div>
		      	</div>
		      	<hr>
		        <div class="container-fluid">
		        	<div class="row imgWrap">
		        		
		        	</div>
		        </div>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		      </div>
		    </div>

		  </div>
		</div>

		<!-- <div class="jumbotron" style="padding:20px 0 10px 0; margin-bottom:0px; background-color: #0e5aa8;">
			<div class="container">
				<a href="#"><img src="https://cdn.shopify.com/s/files/1/1431/0294/t/3/assets/logo.png?16214878102389155724" style="max-width:115px; width:100%;"></a>
			</div>	
		</div> -->
		<div id="nav-wrapper" data-spy="affix" data-offset-top="0">
		<div class="container-fluid w3-black w3-card-4" style="height:42px;">
					<h4 id="fix">Product Import Form</h4>
		</div>
		
	</div>
		<div class="container-fluid">
			<br>
			<hr>
			
			 <div id="datasheet" class="hot handsontable htRowHeaders htColumnHeaders w3-card-4" style=""></div> 
			  
			<h4>&nbsp;</h4>
			<div class="row">
		  		<div class="col-md-12 text-center">
		  			<button id="export-string" type="button" class="w3-btn w3-card-1 w3-round intext-btn">EXPORT CSV</button>		
		  		</div>
		  </div>

			<h2>&nbsp;</h2>
			
		</div>
		<h2>&nbsp;</h2>
		<div class="jumbotron" style="padding:20px 50px 10px 50px; margin-bottom:0px; background-color: black;">
			<div class="container" style="height:150px;">
				<!-- <img src="https://cdn.shopify.com/s/files/1/1431/0294/t/3/assets/logo.png?16214878102389155724" style="max-width:115px; width:100%;"> -->
			</div>	
		</div>
		<div class="container-fluid theme-color" style="border-top: 1px solid gray; background-color: black;">
			<div class="container" style="border-top: 1px solid lightgrey; padding:10px 50px;color: rgba(255, 255, 255, 0.6);">
				<small>
					&copy; 2017
					<a href="/" style="color:white;" title="">PepsiprintStudios</a>
				</small>
			</div>
		</div>
		<!-- // <script type="text/javascript" src="js/bootstrap.js"></script> -->
		<script src="https://docs.handsontable.com/pro/1.7.0/bower_components/handsontable-pro/dist/handsontable.full.min.js"></script>
		<script type="text/javascript" src="js/papaparse.min.js"></script>
		<script type="text/javascript">

			$(document).ready(function(){
				$("#nav-wrapper").on('affix.bs.affix', function(){
					$('.ht_clone_top, .ht_clone_top_left_corner').css('display','block');
				});

				$("#nav-wrapper").on('affix-top.bs.affix', function(){
					$('.ht_clone_top, .ht_clone_top_left_corner').css('display','none');
				});		
			});

			document.addEventListener("DOMContentLoaded", function() {

				

				// var myData = getJSONdata();

				function getJSONdata() {
				// 	var fetchedData = [];
				// 	$.getJSON('json/shippingBlank.json', function(data) {
				// 	    fetchedData = JSON.parse(data);
				// 	});

				// 	return fetchedData;

					// $.ajax({
					//     url: "json/myData.js",
					//     async: false,
					//     success: function (csvd) {
					//         // data = $.csv.toArrays(csvd);
					//         return csvd;
					//     },
					//     dataType: "script",
					//     complete: function () {
					//         // call a function on complete 
					//         // alert('data loaded');

					//     }
					// });
					
					// else
					return  [
								{ remove_this_row: '', add_row_below: '', handle: '', title: '', body: '', vendor: '', type: '', tags: '', add_tags: '', published: '', option1_name: '', option1_value: '', option2_name: '', option2_value: '', add_options: '', variant_sku: '', variant_price: '', image_src: 'https://cdn.shopify.com/s/files/1/1953/3447/files/image2.png?17409574589731538444', add_images: '' },
								{ remove_this_row: '', add_row_below: '', handle: '', title: '', body: '', vendor: '', type: '', tags: '', add_tags: '', published: '', option1_name: '', option1_value: '', option2_name: '', option2_value: '', add_options: '', variant_sku: '', variant_price: '', image_src: '', add_images: '' },
							];

				}


			    var datasheet = document.getElementById('datasheet');

				var hot = new Handsontable(datasheet, {
														data: getJSONdata(),
													    startRows: 1,
													    startCols: 20,
													    colHeaders: ['', '', 'Handle', 'Title', 'Body', 'Vendor', 'Type', 'Tags', 'ADD TAGS', 'Published', 'Option1 Name', 'Option1 Value', 'Option2 Name', 'Option2 Value', 'ADD OPTIONS', 'Variant SKU', 'Variant Price', 'Image Src', 'ADD IMAGES'],
													    rowHeaders: true,
													    preventOverflow: 'horizontal',
													    observeChanges: true,
													    className: "htRight",
													    // contextMenu: true,
													    fixedColumnsLeft: 4,
													    colWidths: ['25' ,'10', '0', '250', '250', '150', '150', '250', '150', '100', '0', '250', '0', '0', '150', '0', '100', '250', '150'],
													    //validator: /(\$[\d]+[\.]?[\d]{1,3})/,
													    //placeholder: '$0.00',
													    // columns: [{col: 0, className: "htCenter"},],
													    columns: [
																	    {
																	   		data: 'remove_this_row',
																	   		className: 'htCenter',
																	   		readOnly: true,
																	   		renderer: removeThisRow
																	    },
																	    {
																	   		data: 'add_row_below',
																	   		className: 'htCenter',
																	   		readOnly: true,
																	   		renderer: addRowBelow
																	    },
																	    {
																			data: "handle",
																			readOnly: true
																		},
																		{
																			data: "title"
																		},
																		{
																			data: "body"
																		},
																		{
																			data: "vendor"
																		},
																		{
																			data: "type"
																		},
																		{
																			data: "tags",
																			readOnly: true
																		},
																		{
																			data: "add_tags",
																			className: 'htCenter',
																	   		readOnly: true,
																	   		renderer: addTags
																		},
																		{
																			data: "published"
																		},
																		{
																			data: "option1_name",
																			readOnly: true
																		},
																		{
																			data: "option1_value",
																			readOnly: true
																		},
																		{
																			data: "option2_name",
																			readOnly: true
																		},
																		{
																			data: "option2_value",
																			readOnly: true
																		},
																		{
																			data: "add_options",
																			className: 'htCenter',
																	   		readOnly: true,
																	   		renderer: addOptions

																		},
																		{
																			data: "variant_sku",
																			readOnly: true
																		},
																		{
																			data: "variant_price"
																		},
																		{
																			data: "image_src",
																			readOnly: true
																		},
																		{
																			data: "add_images",
																			className: 'htCenter',
																	   		readOnly: true,
																	   		renderer: addImages

																		}
																		
																	],
															hiddenColumns: {
														      columns: [2, 10, 12, 13, 15],
														      indicators: true
														    }
													  });

				  function removeThisRow (instance, td, row, col, prop, value, cellProperties) {
				    var escaped = Handsontable.helper.stringify(value),
				      btn;

				    if (escaped.length === 0) {
				      btn = document.createElement('A');
				      btn.setAttribute('class', 'center-block text-center');
				      btn.setAttribute('title', 'Remove this row');
				      btn.style.cursor = 'pointer';
				      btn.innerHTML = '<i class="fa fa-minus-square"></i>';

				      Handsontable.dom.addEvent(btn, 'mousedown', function (e){
				        e.preventDefault(); // prevent selection quirk
				        hot.alter('remove_row', row);
				      });

				      Handsontable.dom.empty(td);
				      td.appendChild(btn);
				    }
				    else {
				      // render as text
				      Handsontable.renderers.TextRenderer.apply(this, arguments);
				    }

				    return td;
				  }

				  function addRowBelow (instance, td, row, col, prop, value, cellProperties) {
				    var escaped = Handsontable.helper.stringify(value),
				      btn;

				    if (escaped.length === 0) {
				      btn = document.createElement('A');
				      btn.setAttribute('class', 'center-block text-center');
				      btn.setAttribute('title', 'Add a row below');
				      btn.style.cursor = 'pointer';
				      btn.innerHTML = '<i class="fa fa-plus-square"></i>';

				      Handsontable.dom.addEvent(btn, 'mousedown', function (e){
				        e.preventDefault(); // prevent selection quirk
				        hot.alter('insert_row', row+1);
				      });

				      Handsontable.dom.empty(td);
				      td.appendChild(btn);
				    }
				    else {
				      // render as text
				      Handsontable.renderers.TextRenderer.apply(this, arguments);
				    }

				    return td;
				  }

				  function addTags (instance, td, row, col, prop, value, cellProperties) {
				    var escaped = Handsontable.helper.stringify(value),
				      btn;

				    if (escaped.length === 0) {
				      btn = document.createElement('A');
				      btn.setAttribute('class', 'center-block text-center');
				      btn.setAttribute('title', 'Add Tags');
				      btn.style.cursor = 'pointer';
				      btn.innerHTML = '<i class="fa fa-plus-square"></i>';

				      Handsontable.dom.addEvent(btn, 'mousedown', function (e){
				        e.preventDefault(); // prevent selection quirk
				        $('#tagModal').modal("show");
				      });

				      Handsontable.dom.empty(td);
				      td.appendChild(btn);
				    }
				    else {
				      // render as text
				      Handsontable.renderers.TextRenderer.apply(this, arguments);
				    }

				    return td;
				  }

				  function addOptions (instance, td, row, col, prop, value, cellProperties) {
				    var escaped = Handsontable.helper.stringify(value),
				      btn;

				    if (escaped.length === 0) {
				      btn = document.createElement('A');
				      btn.setAttribute('class', 'center-block text-center');
				      btn.setAttribute('title', 'Add Options');
				      btn.style.cursor = 'pointer';
				      btn.innerHTML = '<i class="fa fa-plus-square"></i>';

				      Handsontable.dom.addEvent(btn, 'mousedown', function (e){
				        e.preventDefault(); // prevent selection quirk
				        $('#optionModal').modal("show");
				      });

				      Handsontable.dom.empty(td);
				      td.appendChild(btn);
				    }
				    else {
				      // render as text
				      Handsontable.renderers.TextRenderer.apply(this, arguments);
				    }

				    return td;
				  }

				  function addImages (instance, td, row, col, prop, value, cellProperties) {
				    var escaped = Handsontable.helper.stringify(value),
				      btn;

				    if (escaped.length === 0) {
				      btn = document.createElement('A');
				      btn.setAttribute('class', 'center-block text-center');
				      btn.setAttribute('title', 'Add Images');
				      btn.style.cursor = 'pointer';
				      btn.innerHTML = '<i class="fa fa-plus-square"></i>';

				      Handsontable.dom.addEvent(btn, 'mousedown', function (e){
				        e.preventDefault(); // prevent selection quirk
				        value = hot.getDataAtCell(row, col-1);
				        if(value.length > 0){
				        	value = value.split(',');
				        	$('#imageModal .imgWrap').html('');
				        	value.forEach(function(url) {
				        		lastIndex = url.lastIndexOf('.');
        						new_url = url.substr(0, lastIndex)+'_150x'+url.substr(lastIndex);
				        		$('#imageModal .imgWrap').append('<div class="col-sm-3"><img class="img-responsive center-block w3-card-4 animated bounceInDown" style="width:100%; height:auto;" src="'+ new_url +'"/><a class="pull-right w3-circle w3-text-red w3-xlarge w3-card-4 animated rubberBand" style="position:absolute; top:-10px; right:5px;" href="javascript:;"><i class="fa fa-times-circle"></i></a></div>');
				        	});
				        }
				        
				        $('#imageModal').modal("show");
				      });

				      Handsontable.dom.empty(td);
				      td.appendChild(btn);
				    }
				    else {
				      // render as text
				      Handsontable.renderers.TextRenderer.apply(this, arguments);
				    }

				    return td;
				  }

				  // if(!hot){setTimeout(4000);}
				  
				  var buttons = {
				    string: document.getElementById('export-string')
				  };
				  
				  var exportPlugin = hot.getPlugin('exportFile');
				  
				  buttons.string.addEventListener('click', function() {
				    var resultCSV = exportPlugin.exportAsString('csv', {
					  exportHiddenRows: true,     // default false
					  exportHiddenColumns: true,  // default false
					  columnHeaders: true,        // default false
					  rowHeaders: true,           // default false
					  columnDelimiter: ';',       // default ','
					  range: [1, 1, 6, 6]         // [startRow, endRow, startColumn, endColumn]
					});

					var date = new Date();

				    exportPlugin.downloadFile('csv', { filename: 'PepsiPrintProductImport on ' + date.getDate() +'-'+ date.getMonth() +'-'+ date.getYear() + ' at ' + date.getHours() +':'+ date.getMinutes() +':'+ date.getSeconds() });

				    console.log(resultCSV);
				    alert("CSV String = "+resultCSV);
				    var resultJSON = Papa.parse(resultCSV);
					console.log(resultJSON.meta.delimiter);
					
					alert("JSON of CSV String = "+JSON.stringify(resultJSON));
					console.log(resultJSON);
				  });
				  
				  
				  
				  // function bindDumpButton() {
				  //     if (typeof Handsontable === "undefined") {
				  //       return;
				  //     }
				  
				  //     Handsontable.Dom.addEvent(document.body, 'click', function (e) {
				  
				  //       var element = e.target || e.srcElement;
				  
				  //       if (element.nodeName == "BUTTON" && element.name == 'dump') {
				  //         var name = element.getAttribute('data-dump');
				  //         var instance = element.getAttribute('data-instance');
				  //         var hot = window[instance];
				  //         console.log('data of ' + name, hot.getData());
				  //       }
				  //     });
				  //   }
				  // bindDumpButton();

				});

				// csv_upload = document.getElementById("csv_upload");
				// csv_upload_txt = document.getElementById("csv_upload_txt");

				// csv_upload.onchange = function(e){
				// 	    var ext = csv_upload.value.match(/\.([^\.]+)$/)[1];
				// 	    switch(ext)
				// 	    {
				// 	        case 'csv':
				// 	        case 'xls':
				// 	        case 'xlsx':
				// 	            // alert('allowed');
				// 	            break;
				// 	        default:
				// 	            alert('invalid file type');
				// 	            this.value='';
				// 	    }
				// 	    csv_upload_txt.value = csv_upload.value.replace("fakepath","..");
				// };

				function encodeImageFileAsURL(element) {
				  var file = element.files[0];
				  var reader = new FileReader();
				  reader.onloadend = function() {
				    // console.log('RESULT', reader.result);
				    putImgFile(file.name, reader.result.split(',')[1]);
				  }
				  reader.readAsDataURL(file);
				}

				function toDataURL(url, callback) {
				  var xhr = new XMLHttpRequest();
				  xhr.onload = function() {
				    var reader = new FileReader();
				    reader.onloadend = function() {
				      callback(reader.result);
				      // putImgFile(xhr.response.name, reader.result.split(',')[1]);
				    }
				    reader.readAsDataURL(xhr.response);
				  };
				  xhr.open('GET', url);
				  xhr.responseType = 'blob';
				  xhr.send();
				}

				function urlFileLoad(url){
					toDataURL(url, function(dataUrl) {
					  console.log('RESULT:', dataUrl);
					});
				}

				function toDataURL2(src, callback, outputFormat) {
				  var img = new Image();
				  img.crossOrigin = 'Anonymous';
				  img.onload = function() {
				    var canvas = document.createElement('CANVAS');
				    var ctx = canvas.getContext('2d');
				    var dataURL;
				    canvas.height = this.height;
				    canvas.width = this.width;
				    ctx.drawImage(this, 0, 0);
				    dataURL = canvas.toDataURL(outputFormat);
				    callback(dataURL);
				  };
				  img.src = src;
				  if (img.complete || img.complete === undefined) {
				    img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
				    img.src = src;
				  }
				}

				function urlFileLoad2(url){
					toDataURL2(url, function(dataUrl) {
					    console.log('RESULT:', dataUrl);
					    putImgFile(GetFileName(url), dataUrl.split(',')[1]);
					  }, 'png'
					);
				}

				function GetFileName(file_url){
					//this gets the full url
					var url = file_url;
					//this removes the anchor at the end, if there is one
					url = url.substring(0, (url.indexOf("#") == -1) ? url.length : url.indexOf("#"));
					//this removes the query after the file name, if there is one
					url = url.substring(0, (url.indexOf("?") == -1) ? url.length : url.indexOf("?"));
					//this removes everything before the last slash in the path
					url = url.substring(url.lastIndexOf("/") + 1, url.length);
					// to remove extension
					url = url.substring(0, (url.indexOf(".") == -1) ? url.length : url.indexOf("."));
					//return
					if(url.length == 0){
						data = new Date();
						url = "index-"+ date.getTime();
					}
					// alert(url);
					return url;
				}

				var mystring = "3257e8bae9510eb07c36954ed6ff75b3:f65acf2453f6d3d1245efcc743633ce8";
				var encodedString = "";
				var myblob = new Blob([mystring], {
				    type: 'text/plain'
				});
				  
				var reader = new window.FileReader();
				reader.readAsDataURL(myblob); 
				reader.onloadend = function() {
		            base64data = reader.result;                
		            // console.log(base64data );
					// console.log( base64data.substr(base64data.indexOf(',')+1) );

					encodedString = base64data.substr(base64data.indexOf(',')+1);
				}
				
				function putImgFile (assetName, attachment) {
					var jsonData = { "asset": { "key": "assets/"+ assetName, "attachment": '"'+attachment+'"' } };
					console.log(JSON.stringify(jsonData));
					$.ajax({
						url: 'https://3257e8bae9510eb07c36954ed6ff75b3:f65acf2453f6d3d1245efcc743633ce8@lapineteststore.myshopify.com/admin/themes/170017298/assets.json',
						type: 'PUT',
						headers: {
					        'Authorization':'Basic '+ encodedString,
					        'Content-Type':'application/json; character=UTF-8'
					    },
						dataType: 'json',
						data: jsonData, //JSON.stringify(jsonData),
					})
					.done(function(data) {
						console.log("success", data.public_url);
					})
					.fail(function(data) {
						console.log("error", data);
					})
					.always(function() {
						console.log("complete");
					});
					
				}

				function deleteImgFile (assetName) {
					// body...
				}
		</script>
	</body>
</html>